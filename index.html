<!DOCTYPE html>
<html lang="en">
<head>
	<title>geomancer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="jquery-2.1.3.min.js"></script>
	<style>
		@import url(http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700);
		* {
			padding: 0;
			margin: 0;
			text-align: center;
			font-family: 'Open Sans Condensed', sans-serif;
		}
		html, body {
			background-color: #fcfcfa;
		}
		h1 {
			margin: 15px 0 -10px 0;
		}
		#container {
			display: block;
			width: 700px;
			height: 550px;
			left: 0;
			margin: auto;
			margin-top: 50px;
			right: 0;
			border: solid 1px black;
		}
		.question {
		    border: 1px solid #345;
		    left: 0;
		    right: 0;
		    margin: auto;
		    margin-top: 25px;
		    width: 75%;
		    border-radius: 3px;
		    overflow: hidden;
		    background: #fcfcfa url("data:image/png;base64,R0lGODlhDwAUAIABAAAAAP///yH5BAEAAAEALAAAAAAPABQAAAIXjI+py+0Po5wH2HsXzmw//lHiSJZmUAAAOw==") no-repeat 98% 50%;
		}
		.question select {
		    -webkit-appearance: none;
		    background-image: none;
		    background: transparent;
		    border: none;
		    box-shadow: none;
		    height: 40px;
		    padding: 5px 8px;
		    width: 100%;
		}
		.question select:focus {
		    outline: none;
		}
		button {
			background-color: #7BE;
			border-radius: 4px;
			border: solid 1px #345;
			font-size: 1.2em;
			font-weight: 300;
			height: 40px;
			left: 0;
			margin: auto;
			right: 0;
		}
		button:hover {
			background-color: #B1CF6F;
		}
		button:disabled {
			background-color: #ddd;
		}

		button#fortune {
			display: none;
			width: 75%;
			margin-top: 15px;
		}


		img#geo-background {
			position: absolute;
			width: 250px;
			height: auto;
			z-index: 0;
		}
		img.face {
			position: absolute;
			height: 54px;
			margin-left: 200px;
			z-index: 5;
		}
		img#die1 { margin: 0px 0 0 17px }
		img#die2 { margin: 0px 0 0 71px }
		img#die3 { margin: 0px 0 0 125px }
		img#die4 { margin: 0px 0 0 179px }

		div#geomancer-wrapper {
			float: left;
			display: inline-block;
			margin: 40px 17px 0 52px;
			border: solid 1px black;
			height: 200px;
			width: 40%;
			position: relative;
		}
		div#results {
			float: left;
			display: inline-block;
			margin: 40px 0 0 18px;
			border: solid 1px black;
			height: 200px;
			width: 40%;
			position: relative;
		}
		div#geomancer {
			width: 250px;
			left: 0;
			right: 0;
			margin: auto;
			margin-top: 35px;
		}
		button#roll {
			display: inline-block;
			width: 218px;
			margin: 70px 0 0 16px;
			border-radius: 4px;
		}
		div.roll-result {
			margin: -2px 0 -10px 0;
			width: 100%;
			float: left;
			height: 60px;
		}
		div.roll-result img {
			display: inline-block;
			height: 40px;
			margin: 10px 8px 0 0;
		}
		div#your-fortune {
			width: 100%;
			margin: 10px 0 0 0;
			display: inline-block;
			border: solid 1px black;
		}
		div.circle {
			margin: 0;
			padding: 0;
			display: inline-block;
			border-radius: 50%;
			height: 15px;
			width: 15px;
			background-color: #3E4C51;
		}
		div#pattern {
			float: right;
			width: 50%;
			height: 150px;
		}
		div.sub-pattern {
			height: 50%;
			display: inline-block;
			width: 34%;
		}
		div.row {
			display: inline-block;
			padding: 0;
			margin: 0;
			width: 100%;
		}
	</style>
</head>
<body>
	<div id="container">
		<h1 id="title">
			choose a question
		</h1>
		
		<div class="question">
			<select id="question">
				<option value="-1">select a question</option>
				<option value="0">If the asker shall have children?</option>
				<option value="1">q2</option>
				<option value="2">q3</option>
				<option value="3">q4</option>
				<option value="4">q5</option>
			</select>
		</div>
		<button id="fortune">Tell me my fortune</button>
		<div id="geomancer-wrapper">
			<div id="geomancer">
				<img id="geo-background" src="geomancer.png">
				<img id="die1" src="diefaces/die1.png" class="face">
				<img id="die2" src="diefaces/die2.png" class="face">
				<img id="die3" src="diefaces/die3.png" class="face">
				<img id="die4" src="diefaces/die4.png" class="face">
				<button id="roll">roll</button>
				<p>
					<small>
						rolls left: <span id="times">4</span>
					</small>
				</p>
			</div>
		</div>
		<div id="results">
		</div>

		<div id="your-fortune">
			<div id="pattern">
				<!-- <div class="sub-pattern">
					<div class="row">
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
						<div class="circle"></div>
					</div>
				</div>
				<div class="sub-pattern">
					<div class="row">
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
						<div class="circle"></div>
					</div>
				</div>
				<div class="sub-pattern">
					<div class="row">
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
						<div class="circle"></div>
					</div>
					<div class="row">
						<div class="circle"></div>
						<div class="circle"></div>
					</div>
				</div> -->
			</div>
		</div>
	</div>
</body>
<script>
	var roll = function () { return (Math.random() * 4) | 0 }
	var meld = function (a, b) {
		return a.map(function (d, i) {
			return (a[i] + b[i]) % 2;
		})
	}

	// make sure to pass an array of length 16
	var patterns = function (dots) {
		// dots = dots.length == 16 ? dots : Array.apply(null, new Array(16)).map(function () { return Math.random() < 0.5 ? 0 : 1});
		var mothers = [], daughters = [], nephews = [], witnesses = [];

		// generate the mothers and daughters
		for (var i = 0; i < 4; i++) {
			mothers[3 - i] = dots.slice(i << 2, 4 + (i << 2));
			daughters[3 - i] = (function () {
				var t = [];
				for (var j = 0; j < 4; j++) {
					t.push(dots[i + (j << 2)]);
				}
				return t;
			})();
		}

		// generate the nephews
		for (var i = 0; i < 2; i++) {
			nephews[i] = meld(mothers[3 - (i << 1)], mothers[2 - (i << 1)]);
			nephews[i + 2] = meld(daughters[3 - (i << 1)], daughters[2 - (i << 1)]);
		}

		witnesses = [ meld(nephews[0], nephews[1]), meld(nephews[2], nephews[3]) ];

		return witnesses.concat([ meld(witnesses[0], witnesses[1]) ]);
	}

	var r = [];
	var rollFaces = function () {
		var shiftFace = function (n, face, time) {
			face = (1 + face) % 4;
			$("#die" + n).attr("src", "diefaces/die" + (face + 1) + ".png");
			if (time < 300 + 125*Math.random()) {
				setTimeout(function () {
					shiftFace(n, face, time * 1.1);
				}, time)
			} else {
				r[n-1] = face + 1;
			}
		}
		for (var i = 1; i < 5; i++) {
			r[i - 1] = false;
			shiftFace(i, i, 50);
		}
	}

	var appendResults = function (arr) {
		$("#results").append(
			'<div class="roll-result">' +
				'<img src="diefaces/die' + arr[0] + '.png">' +
				'<img src="diefaces/die' + arr[1] + '.png">' +
				'<img src="diefaces/die' + arr[2] + '.png">' +
				'<img src="diefaces/die' + arr[3] + '.png">' +
			'</div>'
		)
	}

	var getCircles = function (n) {
		return (n == 2 ? "<div class='circle'></div>" : "") + "<div class='circle'></div>";
	}

	var generatePattern = function (arr) {
		console.log("generating the pattern...")
		arr = patterns(arr).map(function (row) { return row.map(function (item) { return 2 - item }) })

		console.log(arr);
		for (var i = 0; i < arr.length; i++) {
			var s = "<div class='sub-pattern'>";
			for (var j = 0; j < arr[i].length; j++) {
				s += "<div class='row'>";
				s += getCircles(arr[i][j]);
				s += "</div>";
			}
			$("#pattern").append(s + "</div>");
		}
	}


	var k = 0, total = [];
	var process = function () {
		$("#times").text(4 - ++k);
		if (k < 5) {
			$("#roll").attr("disabled", true);
			rollFaces();

			var l = setInterval(function () {
				if (r.reduce(function (p, c) { return p && c })) {
					$("#roll").attr("disabled", false);
					total = total.concat(r);
					appendResults(r);
					
					clearInterval(l);
					if (k == 4) {
						$("#times").parent().parent().remove();
						$("#roll").attr("disabled", true);
						total = total.map(function (d) {
							return d % 2;
						})
						generatePattern(total);
					}
					console.log(total);
					console.log("k is", k);
				}
			}, 250)
		}
	}

	$(document).ready(function () {
		$("#question").change(function () {
			var v = parseInt($(this).val());
			$("#fortune").css("display", v != -1 ? "block" : "none");
		});

		$("#roll").click(process);
	})







</script>
</html>